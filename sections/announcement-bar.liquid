{% comment %}
---------------------------------------------------------
Theme Shopiweb Premium — Announcement Bar (fixed)
---------------------------------------------------------
{% endcomment %}

{% liquid
  assign pt = section.settings.pt | prepend: 'pt-'
  assign pb = section.settings.pb | prepend: 'pb-'
  assign bg_color = section.settings.bg_color
  if section.settings.bg_gradient
    assign bg_color = bg_color | append: ' bg-gradient'
  endif

  # Expiration globale de la SECTION (masque toute la barre)
  assign section_expiration_ts = section.settings.expiration_time | date: '%s'
%}

<div id="announcement-bar-{{ section.id }}"
     class="{{ bg_color }}"
     {% unless section.settings.expiration_time == blank %}
       data-expiration-time="{{ section_expiration_ts }}"
     {% endunless %}>

  <div class="container">
    <div id="carousel-{{ section.id }}"
         class="carousel slide"
         {% if section.settings.autoplay %} data-bs-ride="carousel" data-bs-interval="5000"{% endif %}>

      <div class="carousel-inner {{ section.settings.text_transform }} {{ section.settings.font_size }}"
           style="max-width: {{ section.settings.max_width | default: '600' }}px; margin: 0 auto;">

        {%- for block in section.blocks -%}
          {% liquid
            # Compte à rebours PAR BLOC (optionnel)
            assign block_expiration_ts = block.settings.countdown_timer | date: '%s'
          %}

          {% capture countdown_timer %}
            {% unless block.settings.countdown_timer == blank %}
              <span class="visually-hidden">{{ 'general.countdown_timer.expires' | t }}</span>
              <ul class="timer-countdown list-unstyled"
                  data-time="{{ block_expiration_ts }}"
                  data-text-d="{{ 'general.countdown_timer.d' | t }}"
                  data-text-h="{{ 'general.countdown_timer.h' | t }}"
                  data-text-m="{{ 'general.countdown_timer.m' | t }}"
                  hidden>
                <li data-days></li>
                <li data-hours></li>
                <li data-minutes></li>
                <li data-seconds></li>
              </ul>
            {% endunless %}
          {% endcapture %}

          <div class="carousel-item {% if forloop.first %}active{% endif %}" {{ block.shopify_attributes }}>
            {% if block.settings.url == blank %}
              <div class="rte text-center lh-sm {{ pt }} {{ pb }}">
                {{ block.settings.description }}
                {{ countdown_timer }}
              </div>
            {% else %}
              <a href="{{ block.settings.url }}" class="d-block {{ pt }} {{ pb }}">
                <div class="rte text-center lh-sm">
                  {{ block.settings.description }}
                  <svg xmlns="http://www.w3.org/2000/svg" class="ms-2" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M5 12h13M12 5l7 7-7 7"/>
                  </svg>
                  {{ countdown_timer }}
                </div>
              </a>
            {% endif %}
          </div>
        {%- endfor -%}
      </div>

      {% if section.settings.controls and section.blocks.size > 1 %}
        <button class="carousel-control carousel-control-prev"
                type="button"
                data-bs-target="#carousel-{{ section.id }}"
                data-bs-slide="prev">
          <span class="carousel-control-icon carousel-control-prev-icon" aria-hidden="true"></span>
          <span class="visually-hidden">{{ 'general.accessibility.previous' | t }}</span>
        </button>
        <button class="carousel-control carousel-control-next"
                type="button"
                data-bs-target="#carousel-{{ section.id }}"
                data-bs-slide="next">
          <span class="carousel-control-icon carousel-control-next-icon" aria-hidden="true"></span>
          <span class="visually-hidden">{{ 'general.accessibility.next' | t }}</span>
        </button>
      {% endif %}
    </div>
  </div>
</div>

{% unless section.settings.expiration_time == blank %}
  <script>
    (function() {
      const sectionEl = document.querySelector('#announcement-bar-{{ section.id }}');
      if (!sectionEl) return;
      const ts = sectionEl.dataset.expirationTime;
      if (ts && Number(ts) <= Date.now() / 1000) {
        sectionEl.remove();
      }
    })();
  </script>
{% endunless %}

{% schema %}
{ /* (votre schéma identique à celui partagé) */ }
{% endschema %}