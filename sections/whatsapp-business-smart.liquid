{% comment %}
WhatsApp Business ‚Äì Smart Button (auto context)
- Ajoute automatiquement : titre de page/produit, SKU (si produit), URL
- Param√©trable depuis l‚Äôadmin (num√©ro, options, messages)
{% endcomment %}

{% schema %}
{
  "name": "WhatsApp Smart Btn",
  "settings": [
    { "type": "text", "id": "wa_phone_e164", "label": "Phone (E.164)", "default": "33769238799" },

    { "type": "header", "content": "Message options" },
    { "type": "textarea", "id": "prefill_prefix", "label": "Prefix", "default": "Bonjour The Pet Society üëã" },
    { "type": "checkbox", "id": "include_context", "label": "Inclure le titre de la page/produit", "default": true },
    { "type": "checkbox", "id": "include_sku", "label": "Inclure SKU (si fiche produit)", "default": true },
    { "type": "checkbox", "id": "include_url", "label": "Inclure l‚ÄôURL de la page", "default": true },
    { "type": "textarea", "id": "prefill_suffix", "label": "Suffix", "default": "Merci üôè" },

    { "type": "header", "content": "Affichage" },
    { "type": "checkbox", "id": "hide_on_mobile", "label": "Cacher sur mobile", "default": false },
    { "type": "checkbox", "id": "hide_on_desktop", "label": "Cacher sur desktop", "default": false }
  ],
  "presets": [{ "name": "WhatsApp Smart Btn", "category": "Contact" }]
}
{% endschema %}

{% liquid
  assign phone = section.settings.wa_phone_e164 | strip
  assign prefix = section.settings.prefill_prefix | strip
  assign suffix = section.settings.prefill_suffix | strip

  assign context_title = nil
  if product
    assign context_title = product.title
  elsif article
    assign context_title = article.title
  else
    assign context_title = page_title
  endif

  assign sku_val = nil
  if product and product.selected_or_first_available_variant
    assign sku_val = product.selected_or_first_available_variant.sku | default: blank
  endif

  assign url_val = 'https://' | append: request.host | append: request.path

  capture composed
    if prefix != blank
      echo prefix
    endif
    if section.settings.include_context and context_title != blank
      echo ' | Sujet: ' | append: context_title
    endif
    if section.settings.include_sku and sku_val != blank
      echo ' | SKU: ' | append: sku_val
    endif
    if section.settings.include_url
      echo ' | Page: ' | append: url_val
    endif
    if suffix != blank
      echo ' | ' | append: suffix
    endif
  endcapture

  assign msg = composed | strip | replace: '  ', ' '
  assign msg_enc = msg | url_encode
%}

<a class="wa-float-btn
  {% if section.settings.hide_on_mobile %} wa-hide-mobile{% endif %}
  {% if section.settings.hide_on_desktop %} wa-hide-desktop{% endif %}"
  href="https://wa.me/{{ phone }}?text={{ msg_enc }}"
  target="_blank" rel="noopener" aria-label="Discuter sur WhatsApp">
  <img
    src="https://cdn.shopify.com/s/files/1/0861/3180/2466/files/whatsApp.png?v=1745524527"
    alt="WhatsApp" width="56" height="56" loading="lazy">
</a>

<style>
.wa-float-btn{
  position:fixed; right:16px; bottom:16px;
  z-index:9999; display:inline-flex; align-items:center; justify-content:center;
  width:56px; height:56px; border-radius:50%; background:#25D366; box-shadow:0 6px 20px rgba(0,0,0,.18);
  transition:transform .15s ease, box-shadow .15s ease;
}
.wa-float-btn:hover{ transform:translateY(-2px); box-shadow:0 10px 24px rgba(0,0,0,.22); }
.wa-float-btn img{ width:32px; height:32px; }
@media (max-width: 767px){
  .wa-float-btn{ right:12px; bottom:12px; width:52px; height:52px; }
  .wa-float-btn img{ width:28px; height:28px; }
}
.wa-hide-mobile{ display:inline-flex; }
@media (max-width: 767px){ .wa-hide-mobile{ display:none !important; } }
@media (min-width: 768px){ .wa-hide-desktop{ display:none !important; } }
</style>
