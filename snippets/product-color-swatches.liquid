{% comment %}
SNIPPET: product-color-swatches.liquid
Affiche des pastilles couleur (swatches) basées sur le métaobjet `color_swatch`
et le metafield de variante `global.ref_variant_id`.
{% endcomment %}

{% liquid
  # 1) Cible produit : priorise l'objet "product" passé au snippet, sinon fallback section
  assign product_color_swatches = product | default: section.settings.product
  if product_color_swatches == blank
    assign product_color_swatches = all_products[request.handle]
  endif

  # 2) Trouver l'index de l'option "color/couleur"
  assign color_opt_index = nil
  if product_color_swatches != blank
    for opt in product_color_swatches.options_with_values
      assign opt_name = opt.name | downcase | strip
      if opt_name contains 'couleur' or opt_name contains 'color'
        assign color_opt_index = forloop.index0
      endif
    endfor
  endif
%}

{% if product_color_swatches and color_opt_index != nil %}
  {%- liquid
    # 3) Variante sélectionnée + clé de correspondance
    assign selected_v = product_color_swatches.selected_or_first_available_variant
    assign selected_key = selected_v.metafields.global.ref_variant_id.value
    if selected_key == blank
      assign selected_key = selected_v.options[color_opt_index]
    endif
    assign selected_key = selected_key | downcase | strip
  -%}

  <div class="color-swatches" role="listbox" aria-label="Color swatches">
    {%- liquid assign seen = '' -%}
    {%- for v in product_color_swatches.variants -%}
      {%- liquid
        # 4) Dédupe par clé (ref_variant_id > option couleur)
        assign key = v.metafields.global.ref_variant_id.value
        if key == blank
          assign key = v.options[color_opt_index]
        endif
        assign key = key | downcase | strip
        if key == blank
          continue
        endif
        assign needle = '|' | append: key | append: '|'
        if seen contains needle
          continue
        endif
        assign seen = seen | append: needle

        # 5) Récup métaobjet color_swatch (image/hex/label)
        assign mo = shop.metaobjects.color_swatch[key]
        assign label = mo.label | default: v.options[color_opt_index]
        assign hex = mo.hex
        assign img = mo.image_1x | default: mo.image
        assign is_checked = false
        if selected_key == key
          assign is_checked = true
        endif
      -%}

      <label class="swatch" for="swatch-{{ section.id }}-{{ forloop.index }}" aria-checked="{{ is_checked }}">
        <input
          id="swatch-{{ section.id }}-{{ forloop.index }}"
          type="radio"
          name="product-color-swatch-{{ section.id }}"
          class="visually-hidden"
          data-variant-id="{{ v.id }}"
          data-variant-option-index="{{ color_opt_index }}"
          value="{{ label | escape }}"
          {% if is_checked %}checked{% endif %}>

        <span class="swatch-chip">
          {%- if img -%}
            <img
              src="{{ img | image_url: width: 48, height: 48, crop: 'center' }}"
              alt="{{ label | escape }}"
              width="24" height="24" loading="lazy">
          {%- elsif hex -%}
            <span class="swatch-dot" style="background: {{ hex }};"></span>
          {%- else -%}
            <span class="swatch-fallback">{{ label }}</span>
          {%- endif -%}
        </span>

        <span class="swatch-label">{{ label }}</span>
      </label>
    {%- endfor -%}
  </div>

  <style>
    .color-swatches { display: flex; flex-wrap: wrap; gap: .5rem; }
    .swatch { display: inline-flex; align-items: center; gap: .5rem; cursor: pointer; position: relative; }
    .swatch input { position: absolute; opacity: 0; pointer-events: none; }
    .swatch-chip { width: 28px; height: 28px; border-radius: 50%; overflow: hidden; display: inline-flex; align-items: center; justify-content: center; border: 1px solid rgba(0,0,0,.12); }
    .swatch-dot { width: 100%; height: 100%; border-radius: 50%; }
    .swatch-fallback { font-size: .75rem; padding: 0 .4rem; }
    .swatch[aria-checked="true"] .swatch-chip,
    .color-swatches .swatch input:checked + .swatch-chip { outline: 2px solid currentColor; outline-offset: 2px; }
    .swatch-label { font-size: .85rem; }
  </style>
{% endif %}