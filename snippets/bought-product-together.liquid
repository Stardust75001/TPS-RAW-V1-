{%- comment -%}
SNIPPET: bought-product-together.liquid
Renders a "Bought together" list for the current product using a block of type "bought_together".
Params expected on render:
  - product: the current product object
  - block:   a section block providing settings (type "bought_together")
Example usage:
{% render 'bought-product-together',
  product: product,
  block: section.blocks | where: 'type', 'bought_together' | first %}
{%- endcomment -%}

{%- assign bt_block = block -%}
{%- assign p_main   = product -%}

{%- if bt_block and p_main -%}
  {%- liquid
    # Image size by orientation
    case bt_block.settings.img_orientation
      when 'square'
        assign img_w = 600
        assign img_h = 600
      when 'landscape'
        assign img_w = 600
        assign img_h = 480
      when 'portrait'
        assign img_w = 480
        assign img_h = 600
      else
        assign img_w = 600
        assign img_h = 600
    endcase

    # Metafield (namespace.key) holding product references
    assign ns = bt_block.settings.metafield | split: '.' | first
    assign key = bt_block.settings.metafield | split: '.' | last

    # Build handles list: current product + related items
    assign handles_csv = p_main.handle | append: ','
    assign rel = p_main.metafields[ns][key].value
    if rel != blank
      for item in rel
        assign h = item.handle | default: item
        assign handles_csv = handles_csv | append: h | append: ','
      endfor
    endif
    assign handles = handles_csv | split: ',' | uniq

    # Spacing classes
    assign mt = bt_block.settings.mt | prepend: 'mt-'
    assign mb = bt_block.settings.mb | prepend: 'mb-'

    # Totals
    assign total_compare_at_price = 0
    assign total_price = 0
  -%}

  {%- if handles.size > 1 -%}
    <style>
      #bought-product-together .img-badge-bought-sale {
        background-color: var(--bs-success);
        position: absolute; top: -0.5rem; right: 0; z-index: 1;
      }
    </style>

    <div id="bought-product-together" class="{{ mt }} {{ mb }}" {{ bt_block.shopify_attributes }}>
      <h2 id="bought-together-title" class="title text-center {{ bt_block.settings.title_size }}">
        {{ bt_block.settings.title }}
      </h2>

      <ul class="product-listing list-unstyled row row-cols-1 row-cols-xl-2 mb-3"
          aria-labelledby="bought-together-title">
        {%- for h in handles limit: bt_block.settings.limit -%}
          {%- assign p = all_products[h] -%}
          {%- if p and p.available -%}
            {%- liquid
              assign v = p.first_available_variant
              assign total_compare_at_price = v.compare_at_price | default: v.price | plus: total_compare_at_price
              assign total_price = v.price | plus: total_price
            -%}
            <li class="product-item py-5">
              <div class="row align-items-center mx-n3">
                <div class="col-5 col-xl-4 px-3">
                  <a class="product-item-img-wrapper link-dark position-relative d-block" href="{{ p.url }}">
                    {%- if p.compare_at_price > p.price -%}
                      <span class="img-badge-bought-sale badge">
                        -{{ p.compare_at_price | minus: p.price | times: 100 | divided_by: p.compare_at_price | round }}%
                      </span>
                    {%- endif -%}
                    <img
                      class="product-item-img img-fluid rounded {{ bt_block.settings.img_thumbnail }} {{ bt_block.settings.shadow_sp }} {{ bt_block.settings.border_color }}"
                      src="{{ p.featured_image | image_url: width: img_w, height: img_h, crop: 'center' }}"
                      alt="{{ p.featured_image.alt | escape }}"
                      width="{{ img_w }}" height="{{ img_h }}" loading="lazy">
                  </a>
                </div>

                <div class="col-7 col-xl-8 px-3">
                  <h3 class="product-item-title h6 mb-3">
                    {{ p.title }}
                    {%- if forloop.first -%}
                      <small class="text-primary">({{ 'product.bought_together.this_item' | t }})</small>
                    {%- endif -%}
                  </h3>

                  {% render 'product-rating-badge', product: p %}

                  <p class="product-item-price mb-0"
                     data-compare-at-price="{{ p.first_available_variant.compare_at_price }}"
                     data-price="{{ p.first_available_variant.price }}">
                    {%- if p.first_available_variant.compare_at_price > p.price -%}
                      <span class="product-item-price-final me-1">
                        <span class="visually-hidden">{{ 'product.price_sale' | t }}&nbsp;</span>
                        {{ p.first_available_variant.price | money }}
                      </span>
                      <span class="product-item-price-compare text-muted">
                        <span class="visually-hidden">{{ 'product.price_regular' | t }}&nbsp;</span>
                        <s>{{ p.first_available_variant.compare_at_price | money }}</s>
                      </span>
                    {%- else -%}
                      <span class="product-item-price-final">{{ p.first_available_variant.price | money }}</span>
                    {%- endif -%}
                  </p>

                  {%- if p.has_only_default_variant -%}
                    <input type="hidden" name="id" value="{{ p.first_available_variant.id }}">
                  {%- else -%}
                    <select class="form-select form-select-sm mt-4"
                            name="id"
                            aria-label="{{ 'product.select_variant' | t }}"
                            onchange="handleProductItemVariantChange(this, event)">
                      {%- for variant in p.variants -%}
                        {%- if variant.available -%}
                          <option value="{{ variant.id }}"
                                  data-compare-at-price="{{ variant.compare_at_price }}"
                                  data-price="{{ variant.price }}"
                                  {%- if variant.image -%}
                                    data-variant-image="{{ variant.image | image_url: width: img_w, height: img_h, crop: 'center' }}"
                                  {%- endif -%}>
                            {{ variant.title }}
                          </option>
                        {%- endif -%}
                      {%- endfor -%}
                    </select>
                  {%- endif -%}

                  <div class="mt-4">
                    <div class="form-check">
                      <input id="check-bought-together-{{ p.id }}" class="check-bought-together form-check-input" type="checkbox" checked>
                      <label class="form-check-label" for="check-bought-together-{{ p.id }}">
                        {{ 'product.bought_together.select_this' | t }}
                      </label>
                    </div>
                  </div>
                </div>
              </div>
            </li>
          {%- endif -%}
        {%- endfor -%}
      </ul>

      <div id="bought-together-footer" class="text-center bg-light p-6 rounded">
        <p id="bought-together-total" class="mb-3 fw-500" aria-live="polite" aria-atomic="true"
           data-text-total-price="{{ 'product.bought_together.total_price' | t }}">
          {{ 'product.bought_together.total_price' | t }}:
          {%- if total_compare_at_price > total_price -%}
            <span class="bought-together-total-price text-success me-2">
              <span class="visually-hidden">{{ 'product.price_sale' | t }}&nbsp;</span>
              {{ total_price | money }}
            </span>
            <span class="bought-together-total-compare-price text-muted">
              <span class="visually-hidden">{{ 'product.price_regular' | t }}&nbsp;</span>
              <s>{{ total_compare_at_price | money }}</s>
            </span>
          {%- else -%}
            <span class="bought-together-total-price">{{ total_price | money }}</span>
          {%- endif -%}
        </p>
        <button id="add-to-cart-bought-together" class="btn btn-primary" type="button"
                data-text-add-to-cart="{{ 'product.bought_together.add_selected_to_cart' | t }}">
          {{ 'product.bought_together.add_selected_to_cart' | t }}
        </button>
      </div>
    </div>
  {%- endif -%}
{%- endif -%}