{% if settings.cart_upsell_enable %}
    {% liquid
    assign layout = settings.cart_upsell_layout
      
        case settings.offcanvas_img_orientation
            when 'square'
                assign img_width  = 600
                assign img_height = 600
            when 'landscape'
                assign img_width  = 600
                assign img_height = 480
            when 'potrait'
                assign img_width  = 480
                assign img_height = 600
        endcase

        for line_item in cart.items
            assign handles_in_cart = handles_in_cart | append: line_item.product.handle | append: ','
        endfor

        if settings.cart_upsell_collection == blank
            assign metafield_namespace = settings.cart_upsell_metafield | split: '.' | first
            assign metafield_key = settings.cart_upsell_metafield | split: '.' | last

            for line_item in cart.items
                for product in line_item.product.metafields[metafield_namespace][metafield_key].value
                    unless handles_in_cart contains product.handle
                        unless upsell_handles contains product.handle
                            if product.available
                                assign upsell_handles = upsell_handles | append: product.handle | append: ','
                            endif
                        endunless
                    endunless
                endfor
            endfor
        else
            for product in settings.cart_upsell_collection.products
                unless handles_in_cart contains product.handle
                    if product.available
                        assign upsell_handles = upsell_handles | append: product.handle | append: ','
                    endif
                endunless
            endfor
        endif
    %}

    {% unless upsell_handles == blank %}
    {% assign upsell_handles = upsell_handles | split: ',' %}
        <div id="cart-upsell" class="">
            <h3 id="cart-upsell-title" class="h6 mb-4">
                {{ settings.cart_upsell_title }}
            </h3>
            {% if layout == 'horizontal' %}
                <ul id="cart-upsell-list" class="cart-upsell-list-horizontal product-listing list-unstyled">
                    {% for handle in upsell_handles limit: settings.cart_upsell_limit %}
                        {% assign product = all_products[handle] %}
                        <li class="product-item text-center px-3">
                            <a class="link-dark" href="{{ product.url }}">
                                <img 
                                    class="product-item-img img-fluid mb-3 rounded {{ settings.offcanvas_img_thumbnail }} {{ settings.offcanvas_shadow_sp }} {{ settings.offcanvas_border_color }}"
                                    src="{{ product.featured_image | image_url: width: img_width, height: img_height, crop: 'center' }}" 
                                    alt="{{ product.featured_image.alt | escape }}"
                                    width="{{ img_width }}"
                                    height="{{ img_height }}" 
                                    loading="lazy">
                                <h3 class="product-item-title h6 mb-2 {{ settings.cart_upsell_product_title_truncate }}" title="{{ product.title }}">
                                    {{ product.title }}
                                </h3>
                            </a>
                            {%- comment -%} Inlined product-rating-badge.liquid {%- endcomment -%}
                            {% if settings.star_style == 'shopitrust' %}
                                <div class="stp-star mb-3"
                                     data-id="{{ product.id }}"
                                     data-rating-stp="{{ product.metafields.shopiweb.rating_shopitrust }}" 
                                     data-num-reviews-stp="{{ product.metafields.shopiweb.number_shopitrust }}">
                                            {% liquid
                                                assign stars_rating = product.metafields.shopiweb.rating_shopitrust
                                            %}
                                    {% assign colors = "#e8e8eb,#ff3722,#ff8622,#ffce00,#73cf11,#00b67a" | split: "," %}
                                    {% assign full_stars = stars_rating | floor %}
                                    {% assign half_star_present = stars_rating | modulo: 1 %}
                                    {% assign next_star = full_stars | plus: 1 %}
                                    {% for i in (1..5) %}
                                        {% if i <= full_stars %}
                                            {% assign color = colors[full_stars] %}
                                            <svg width="14" height="14" viewBox="0 0 16 16" fill="{{ color }}" class="me-n1" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                                                <path d="M16 0H0V16H16V0Z" fill="{{ color }}"></path>
                                                <path d="M5.8,9.3L8,10.8l3.5,2.5l-1.3-4.1l3.5-2.5H9.3L8,2.7L6.7,6.7H2.4L5.8,9.3z M13.6,6.7H9.3L8,2.7L6.7,6.7H2.4l3.5,2.5l-1.3,4.1L8,10.8l2.1-1.5L13.6,6.7z" fill="white"></path>
                                            </svg>
                                        {% elsif i == next_star and half_star_present > 0 %}
                                            {% assign gradient_color = colors[full_stars] %}
                                            <svg width="14" height="14" viewBox="0 0 16 16" class="me-n1" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                                                <defs>
                                                    <linearGradient id="half_grad{{ i }}">
                                                        <stop offset="50%" stop-color="{{ gradient_color }}"/>
                                                    </linearGradient>
                                                </defs>
                                                <rect width="14" height="14" fill="url(#half_grad{{ i }})"/>
                                            </svg>
                                        {% endif %}
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <p class="product-item-price small mb-4">
                                {% if product.first_available_variant.compare_at_price > product.price %}
                                    <span class="product-item-price-final me-1">
                                        <span class="visually-hidden">
                                            {{ 'product.price_sale' | t }} &nbsp;
                                        </span>
                                        {{ product.first_available_variant.price | money }}
                                    </span>
                                    <span class="product-item-price-compare text-muted">
                                        <span class="visually-hidden">
                                            {{ 'product.price_regular' | t }} &nbsp;
                                        </span>
                                        <s>
                                            {{ product.first_available_variant.compare_at_price | money }}
                                        </s>
                                    </span>
                                {% else %}
                                    <span class="product-item-price-final">
                                        {{ product.first_available_variant.price | money }}
                                    </span>
                                {% endif %}
                            </p>
                                                        {%- comment -%} Inlined cart-upsell-product-form.liquid {%- endcomment -%}
                                                        <div class="form-wrapper">
                                                                {% form 'product', product, onsubmit: 'handleAddToCartFormSubmit(this, event)' %}
                                                                        {% if product.has_only_default_variant %}
                                                                                <input type="hidden" name="id" value="{{ product.first_available_variant.id }}">
                                                                        {% else %}
                                                                                <select 
                                                                                        class="form-select form-select-sm w-100 mb-3" 
                                                                                        name="id" 
                                                                                        aria-label="{{ 'product.select_variant' | t }}"
                                                                                        onchange="handleProductItemVariantChange(this, event)">
                                                                                        {% for variant in product.variants %}
                                                                                                <option 
                                                                                                        value="{{ variant.id }}"
                                                                                                        data-compare-at-price="{{ variant.compare_at_price }}"
                                                                                                        data-price="{{ variant.price }}"
                                                                                                        {% if variant.image %}
                                                                                                                data-variant-image="{{ variant.image | image_url: width: img_width, height: img_height, crop: 'center' }}"
                                                                                                        {% endif %}
                                                                                                        >
                                                                                                        {{ variant.title }}
                                                                                                </option>
                                                                                        {% endfor %}
                                                                                </select>
                                                                                <!-- Inlined product-color-swatches.liquid -->
                                                                                {% liquid
                                                                                    assign product_color_swatches = product
                                                                                    if product_color_swatches == blank
                                                                                        assign product_color_swatches = all_products[request.handle]
                                                                                    endif
                                                                                    if product_color_swatches != blank
                                                                                        assign color_opt_index = nil
                                                                                        for opt in product_color_swatches.options_with_values
                                                                                            assign opt_name = opt.name | downcase
                                                                                            if opt_name contains 'couleur' or opt_name contains 'color'
                                                                                                assign color_opt_index = forloop.index0
                                                                                            endif
                                                                                        endfor
                                                                                        if color_opt_index != nil
                                                                                            assign seen = ''
                                                                                            for v in product_color_swatches.variants
                                                                                                assign key = v.metafields.global.ref_variant_id.value | default: v.options[color_opt_index] | downcase | strip
                                                                                                if key == blank
                                                                                                    continue
                                                                                                endif
                                                                                                assign needle = '|' | append: key | append: '|'
                                                                                                if seen contains needle
                                                                                                    continue
                                                                                                endif
                                                                                                assign seen = seen | append: '|' | append: key | append: '|'
                                                                                                
                                                                                            endfor
                                                                                        endif
                                                                                    endif
                                                                                %}
                                                                        {% endif %}
                                                                        <button
                                                                                class="btn-atc btn btn-sm btn-primary w-100 text-nowrap" 
                                                                                type="submit"
                                                                                name="add"
                                                                                data-text-add-to-cart="{{ 'product.add' | t }}"
                                                                                {% unless product.available %}
                                                                                        disabled
                                                                                {% endunless %}>
                                                                                {% if product.available %}
                                                                                        {{ 'product.add' | t }}
                                                                                {% else %}
                                                                                        {{ 'product.sold_out' | t }}
                                                                                {% endif %}
                                                                        </button>
                                                                {% endform %}
                                                        </div>
                        </li>
                    {% endfor %}
                </ul>
            {% else %}
                <ul id="cart-upsell-list" class="cart-upsell-list-vertical product-listing list-unstyled">
                    {% for handle in upsell_handles limit: settings.cart_upsell_limit %}
                        {% assign product = all_products[handle] %}
                        <li class="product-item py-3">
                            <div class="row align-items-center mx-n3">
                                <div class="col-4 px-3">
                                    <a class="link-dark" href="{{ product.url }}">
                                        <img 
                                            class="product-item-img img-fluid mb-3 rounded {{ settings.offcanvas_img_thumbnail }} {{ settings.offcanvas_shadow_sp }} {{ settings.offcanvas_border_color }}"
                                            src="{{ product.featured_image | image_url: width: img_width, height: img_height, crop: 'center' }}" 
                                            alt="{{ product.featured_image.alt | escape }}"
                                            width="{{ img_width }}"
                                            height="{{ img_height }}" 
                                            loading="lazy">
                                    </a>
                                </div>
                                <div class="col-8 px-3">
                                    <h3 class="product-item-title h6 mb-1 {{ settings.cart_upsell_product_title_truncate }}" title="{{ product.title }}">
                                        {{ product.title }}
                                    </h3>
                                    {% render 'product-rating-badge', product: product %}
                                    <p class="product-item-price small mb-3">
                                        {% if product.first_available_variant.compare_at_price > product.price %}
                                            <span class="product-item-price-final me-1">
                                                <span class="visually-hidden">
                                                    {{ 'product.price_sale' | t }} &nbsp;
                                                </span>
                                                {{ product.first_available_variant.price | money }}
                                            </span>
                                            <span class="product-item-price-compare text-muted">
                                                <span class="visually-hidden">
                                                    {{ 'product.price_regular' | t }} &nbsp;
                                                </span>
                                                <s>
                                                    {{ product.first_available_variant.compare_at_price | money }}
                                                </s>
                                            </span>
                                        {% else %}
                                            <span class="product-item-price-final">
                                                {{ product.first_available_variant.price | money }}
                                            </span>
                                        {% endif %}
                                    </p>
                                    {% render 'cart-upsell-product-form', product: product %}
                                </div>
                            </div>
                        </li>
                    {% endfor %}
                </ul>
            {% endif %}
        </div>
    {% endunless %}
{% endif %}