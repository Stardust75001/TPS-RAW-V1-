name: Theme CI (structure + sanity + JSON)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  theme-ci:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: "Sanity: theme structure at repo root"
        shell: bash
        run: |
          set -euo pipefail
          for p in layout/theme.liquid config/settings_schema.json; do
            if [[ ! -f "$p" ]]; then
              echo "::error file=$p::missing required file $p"
              exit 1
            fi
          done
          for d in assets sections snippets templates locales; do
            if [[ ! -d "$d" ]]; then
              echo "::error file=$d::missing required folder $d"
              exit 1
            fi
          done
          echo "Theme structure OK ✅"

      - name: Validate JSON files
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update -y && sudo apt-get install -y jq
          # Validate all locale JSON files
          find locales -type f -name '*.json' -print0 | while IFS= read -r -d '' f; do
            echo "Checking $f"
            if ! jq empty "$f" >/dev/null 2>&1; then
              echo "::error file=$f::Invalid JSON syntax"
              exit 1
            fi
          done
          echo "✅ All locale JSON files valid"

      - name: Run theme-check
        uses: shopify/theme-check-action@v2
        with:
          flags: "--fail-level error"
          # Uncomment the next line and create .theme-check.yml for custom rules
          # config: ".theme-check.yml"

      - name: Validate Liquid syntax
        run: |
          npm install -g @shopify/liquid-linter
          liquid-linter "sections/*.liquid" "snippets/*.liquid" "layout/*.liquid" "templates/*.liquid"

      - name: Check asset file sizes
        run: |
          find assets -type f -size +500k -print | while read file; do
            echo "::error file=$file::Asset file too large: $file"
            exit 1
          done

      - name: Validate section schemas
        run: |
          for file in sections/*.liquid; do
            if ! grep -q '{% schema %}' "$file"; then
              echo "::error file=$file::Missing schema tag in $file"
              exit 1
            fi
          done
            for file in sections/*.liquid; do
              if ! grep -q '{% schema %}' "$file"; then
                echo "::error file=$file::Missing schema tag in $file"
                exit 1
              fi
            done
