name: Theme CI (structure + sanity + JSON)

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  theme-ci:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: "Sanity: theme structure at repo root"
        shell: bash
        run: |
          set -euo pipefail
          for p in layout/theme.liquid config/settings_schema.json; do
            if [[ ! -f "$p" ]]; then
              echo "::error file=$p::missing required file $p"
              exit 1
            fi
          done
          for d in assets sections snippets templates locales; do
            if [[ ! -d "$d" ]]; then
              echo "::error file=$d::missing required folder $d"
              exit 1
            fi
          done
          echo "✅ Theme structure OK"

      - name: "Validate JSON files (locales)"
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update -y
          sudo apt-get install -y jq
          find locales -type f -name '*.json' -print0 |
          while IFS= read -r -d '' f; do
            echo "Checking $f"
            jq empty "$f"
          done
          echo "✅ All locale JSON files valid"

      - name: "Setup Ruby"
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: false

      - name: "Install theme-check"
        shell: bash
        run: |
          gem install --user-install theme-check
          echo "$(ruby -r rubygems -e 'puts Gem.user_dir')/bin" >> "$GITHUB_PATH"

      - name: "Run theme-check"
        shell: bash
        run: |
          set -euo pipefail
          echo "theme-check version:"
          theme-check --version
          echo "Running theme-check..."
          theme-check .
